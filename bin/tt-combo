#!/usr/bin/env python3
import os
import sys
import subprocess
from typing import Optional
from datetime import datetime
import webbrowser

SCRIPT_DIR = os.path.dirname(os.path.realpath(sys.argv[0]))
REPO_ROOT = os.path.dirname(SCRIPT_DIR)
sys.path.insert(0, REPO_ROOT)

from common import (
    load_threads_lines,
    save_threads_lines,
    mark_open_thread_done,
    ensure_threads_file_exists,
    reorder_threads_file,
)

import re

def extract_description(content):
    # Match [**desc**](url) or **desc**
    m = re.match(r"\[\*\*(.*?)\*\*\]\([^)]+\)", content)
    if m:
        return m.group(1)
    m = re.match(r"\*\*(.*?)\*\*", content)
    if m:
        return m.group(1)
    return None

def extract_link(content):
    # Match [**desc**](url)
    m = re.match(r"\[\*\*.*?\*\*\]\(([^)]+)\)", content)
    if m:
        return m.group(1)
    return None

def format_age(ts_str):
    try:
        created = datetime.fromisoformat(ts_str)
        now = datetime.now()
        delta = now - created
        total_minutes = int(delta.total_seconds() // 60)
        if total_minutes < 60:
            return f"{total_minutes}m"
        total_hours = total_minutes // 60
        rem_minutes = total_minutes % 60
        if total_hours < 24:
            return f"{total_hours}h {rem_minutes}m"
        days = total_hours // 24
        rem_hours = total_hours % 24
        return f"{days}d {rem_hours}h {rem_minutes}m"
    except Exception:
        return ""

def get_open_threads(lines):
    open_indices = []
    open_tasks = []
    open_links = []
    for i, line in enumerate(lines):
        if "- [ ]" in line:
            # Remove checkbox and timestamp for display
            content = line.strip()[5:].strip()
            ts_str = None
            if "<!--" in line:
                ts_comment = line[line.index("<!--")+4:line.index("-->")].strip()
                ts_str = ts_comment.split()[0]  # Should be ISO string
            if "<!--" in content:
                content = content[:content.index("<!--")].strip()
            desc = extract_description(content)
            link = extract_link(content)
            if desc:
                display = desc
            else:
                display = content
            if link:
                display = f"{display} ðŸ”—"
            if ts_str:
                age = format_age(ts_str)
                if age:
                    display = f"{display} [{age}]"
            open_indices.append(i)
            open_tasks.append(display)
            open_links.append(link)
    return open_indices, open_tasks, open_links

def prompt_combo(open_tasks, open_links) -> Optional[str]:
    if not open_tasks:
        script = '''
        set dialogResult to display dialog "No open threads. Enter a new thread description:" default answer "" buttons {"Add", "Cancel"} default button "Add"
        if button returned of dialogResult is "Cancel" then
            return "__CANCEL__"
        else
            return text returned of dialogResult
        end if
        '''
    else:
        def escape_applescript(s):
            return s.replace("\\", "\\\\").replace('"', '\\"')
        numbered = "\n".join(f"{i+1}. {escape_applescript(task)}" for i, task in enumerate(open_tasks))
        has_links = any(open_links)
        extra = ""
        if has_links:
            extra = "\\nType lN (e.g. l2) to open the link for item N (with ðŸ”—)."
        script = f'''
        set dialogResult to display dialog "Open threads:\\n\\n{numbered}\\n\\nEnter a number to mark a thread as done, or type a new thread description to add it.{extra}" default answer "" buttons {{"OK", "Cancel"}} default button "OK"
        if button returned of dialogResult is "Cancel" then
            return "__CANCEL__"
        else
            return text returned of dialogResult
        end if
        '''
    print("DEBUG: AppleScript being passed to osascript:\n", script)
    result = subprocess.run(
        ["osascript", "-e", script],
        capture_output=True,
        text=True,
    )
    print("DEBUG: osascript returncode:", result.returncode)
    print("DEBUG: osascript stdout:", result.stdout.strip())
    print("DEBUG: osascript stderr:", result.stderr.strip())
    if result.returncode != 0:
        return None
    out = result.stdout.strip()
    if out == "__CANCEL__":
        return None
    return out

def is_url(s: str) -> bool:
    return s.startswith("http://") or s.startswith("https://")

def add_thread(desc: str):
    threads_file = ensure_threads_file_exists()
    # Try to get front app and title for context (optional)
    try:
        import subprocess
        script = r'''
        tell application "System Events"
            set frontApp to name of first process whose frontmost is true
        end tell
        tell application frontApp
            if (count of windows) > 0 then
                set winTitle to name of front window
            else
                set winTitle to ""
            end if
        end tell
        return frontApp & "||" & winTitle
        '''
        result = subprocess.run(
            ["osascript", "-e", script],
            capture_output=True,
            text=True,
        )
        if result.returncode == 0:
            raw = result.stdout.strip()
            if "||" in raw:
                app, title = raw.split("||", 1)
                app = app.strip()
                title = title.strip()
            else:
                app, title = raw.strip() or "unknown-app", ""
        else:
            app, title = "", ""
    except Exception:
        app, title = "", ""

    url = ""
    if app in {"Google Chrome", "Safari", "Arc"}:
        try:
            if app == "Google Chrome":
                script = r'''
                tell application "Google Chrome"
                    if (count of windows) > 0 and (count of tabs of front window) > 0 then
                        return URL of active tab of front window
                    else
                        return ""
                    end if
                end tell
                '''
            elif app == "Safari":
                script = r'''
                tell application "Safari"
                    if (count of windows) > 0 and (count of tabs of front window) > 0 then
                        return URL of current tab of front window
                    else
                        return ""
                    end if
                end tell
                '''
            elif app == "Arc":
                script = r'''
                tell application "Arc"
                    if (count of windows) > 0 and (count of tabs of front window) > 0 then
                        return URL of active tab of front window
                    else
                        return ""
                    end if
                end tell
                '''
            else:
                script = ""
            if script:
                result = subprocess.run(
                    ["osascript", "-e", script],
                    capture_output=True,
                    text=True,
                )
                if result.returncode == 0:
                    url = result.stdout.strip()
        except Exception:
            url = ""

    parts = []
    desc_part = ""
    if desc:
        if is_url(desc):
            desc_part = f"[**{desc}**]({desc})"
        elif url:
            desc_part = f"[**{desc}**]({url})"
        else:
            desc_part = f"**{desc}**"
    if desc_part:
        parts.append(desc_part)
    if app:
        parts.append(app)
    if title:
        parts.append(title)
    summary = " â€” ".join([p for p in parts if p])
    if not summary:
        summary = "Unnamed thread"
    timestamp = datetime.now().isoformat(timespec="seconds")
    entry = f"- [ ] {summary}  <!-- {timestamp} -->\n"
    with open(threads_file, "a", encoding="utf-8") as f:
        f.write(entry)
    reorder_threads_file()
    print(f"Added thread:\n  {summary}")
    print(f"Stored in: {threads_file}")


def main():
    lines = load_threads_lines()
    open_indices, open_tasks, open_links = get_open_threads(lines)
    user_input: Optional[str] = prompt_combo(open_tasks, open_links)
    if user_input is None or user_input.strip() == "":
        print("Canceled.")
        sys.exit(0)
    user_input = user_input.strip()
    print(f"User input: {user_input}")
    # Check for lN pattern to open link
    if user_input.lower().startswith("l") and user_input[1:].isdigit():
        n = int(user_input[1:])
        if n <= 0 or n > len(open_indices):
            print(f"Number must be between 1 and {len(open_indices)}.")
            sys.exit(1)
        link = open_links[n - 1]
        if link:
            print(f"Opening link for item {n}: {link}")
            webbrowser.open(link)
        else:
            print(f"No link attached to item {n}.")
        sys.exit(0)
    elif user_input.isdigit():
        n = int(user_input)
        if n <= 0 or n > len(open_indices):
            print(f"Number must be between 1 and {len(open_indices)}.")
            sys.exit(1)
        # Ask for confirmation before marking as done
        confirm_script = f'''
        set dialogResult to display dialog "Are you sure you want to mark item #{n} as done?\\n\\n{open_tasks[n-1]}" buttons {{"Yes", "No"}} default button "Yes"
        if button returned of dialogResult is "Yes" then
            return "YES"
        else
            return "NO"
        end if
        '''
        confirm_result = subprocess.run(
            ["osascript", "-e", confirm_script],
            capture_output=True,
            text=True,
        )
        if confirm_result.returncode != 0 or confirm_result.stdout.strip() != "YES":
            print("Canceled marking as done.")
            sys.exit(0)
        new_lines, success = mark_open_thread_done(lines, n - 1)
        if not success:
            print(f"Could not mark thread #{n} as done (out of range?).")
            sys.exit(1)
        save_threads_lines(new_lines)
        reorder_threads_file()
        print(f"Marked thread #{n} as done.")
    else:
        add_thread(user_input)

if __name__ == "__main__":
    main()
