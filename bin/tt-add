#!/usr/bin/env python3
import os
import subprocess
from datetime import datetime

from pathlib import Path

# Ensure imports work when installed via symlink
import sys
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
REPO_ROOT = os.path.dirname(SCRIPT_DIR)
sys.path.insert(0, REPO_ROOT)

from common import ensure_threads_file_exists  # type: ignore


def get_front_app_and_title() -> tuple[str, str]:
    script = r'''
    tell application "System Events"
        set frontApp to name of first process whose frontmost is true
    end tell
    tell application frontApp
        if (count of windows) > 0 then
            set winTitle to name of front window
        else
            set winTitle to ""
        end if
    end tell
    return frontApp & "||" & winTitle
    '''
    result = subprocess.run(
        ["osascript", "-e", script],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return "unknown-app", ""
    raw = result.stdout.strip()
    if "||" in raw:
        app, title = raw.split("||", 1)
        return app.strip(), title.strip()
    return raw.strip() or "unknown-app", ""


def prompt_description() -> str:
    script = r'''
    display dialog "Thread description (optional):" default answer "" buttons {"OK"} default button 1
    set userText to text returned of result
    return userText
    '''
    result = subprocess.run(
        ["osascript", "-e", script],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return ""
    return result.stdout.strip()


def main():
    threads_file = ensure_threads_file_exists()
    app, title = get_front_app_and_title()
    desc = prompt_description()

    parts = []
    if app:
        parts.append(app)
    if title:
        parts.append(title)
    if desc:
        parts.append(desc)

    summary = " â€” ".join([p for p in parts if p])

    if not summary:
        summary = "Unnamed thread"

    timestamp = datetime.now().isoformat(timespec="seconds")
    entry = f"- [ ] {summary}  <!-- {timestamp} -->\n"

    with open(threads_file, "a", encoding="utf-8") as f:
        f.write(entry)

    print(f"Added thread:\n  {summary}")
    print(f"Stored in: {threads_file}")


if __name__ == "__main__":
    main()
